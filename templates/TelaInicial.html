<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Data Butcher — Login / Cadastro</title>
  <style>
    :root {
      --bg: #0f1724; 
      --card: #0b1220; 
      --accent: #ef4444; 
      --muted: #9aa4b2; 
      --glass: rgba(255, 255, 255, 0.03);
      --radius: 12px; 
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: linear-gradient(180deg, #071021 0%, #0b1220 100%);
      color: #e6eef6;
    }
    .container {
      width: 980px;
      max-width: 94%;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 28px;
      align-items: center;
    }
    .hero {
      padding: 36px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
      border-radius: var(--radius);
      box-shadow: 0 6px 30px rgba(2, 6, 23, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.03);
    }
    .logo {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 18px;
    }
    .logo .mark {
      width: 52px;
      height: 52px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), #fb923c);
      display: grid;
      place-items: center;
      font-weight: 700;
    }
    h1 {
      margin: 0 0 8px 0;
      font-size: 22px;
    }
    p.lead {
      margin: 0;
      color: var(--muted);
    }
    .card {
      background: linear-gradient(180deg, var(--card), rgba(255, 255, 255, 0.02));
      padding: 22px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6);
    }
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
    }
    .tabs button {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      background: transparent;
      border: 0;
      color: var(--muted);
      cursor: pointer;
    }
    .tabs button.active {
      background: var(--glass);
      color: #e6eef6;
      font-weight: 600;
    }
    form {
      display: grid;
      gap: 12px;
    }
    label {
      font-size: 13px;
      color: var(--muted);
    }
    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: transparent;
      color: inherit;
      outline: none;
    }
    .row {
      display: flex;
      gap: 12px;
    }
    .row .col {
      flex: 1;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
    }
    .btn.primary {
      background: linear-gradient(90deg, var(--accent), #fb923c);
      color: #061022;
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.04);
      color: var(--muted);
    }
    .muted {
      color: var(--muted);
      font-size: 13px;
    }
    .error {
      color: #ffb4b4;
      font-size: 13px;
    }
    .success {
      color: #73ed73;
      font-size: 13px;
    }
    .small {
      font-size: 13px;
      color: var(--muted);
    }
    .toggle-pass {
      background: transparent;
      border: 0;
      color: var(--muted);
      cursor: pointer;
    }
    footer {
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 880px) {
      .container {
        grid-template-columns: 1fr;
      }
      .hero {
        order: 2;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <section class="hero card">
      <div class="logo"><div class="mark">DB</div><div>
        <h1>Data Butcher</h1>
        <p class="lead">Painel seguro para ingestão e tratamento de dados — acesso restrito. Faça login ou crie sua conta abaixo.</p>
      </div></div>

      <footer>
        <div class="small">© Data Butcher</div>
      </footer>
    </section>

    <aside class="card" style="min-width:320px">
      <div class="tabs" role="tablist">
        <button id="tab-login" class="active" aria-controls="login" role="tab">Login</button>
        <button id="tab-signup" aria-controls="signup" role="tab">Cadastro</button>
      </div>

      <div id="panes">
        <form id="login" autocomplete="on">
          <div>
            <label for="login-name">Nome</label>
            <input id="login-name" name="name" type="text" placeholder="Seu nome" required />
          </div>
          <div>
            <label for="login-pass">Senha</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input id="login-pass" name="password" type="password" placeholder="••••••••" required />
              <button type="button" class="toggle-pass" data-target="login-pass">Mostrar</button>
            </div>
          </div>
          <div class="actions">
            <div class="muted"><label><input type="checkbox"/> Lembrar-me</label></div>
            <button class="btn primary" type="submit">Entrar</button>
          </div>
          <div id="login-msg" class="error" aria-live="polite"></div>
        </form>

        <form id="signup" style="display: none" autocomplete="on">
          <div>
            <label for="s-name">Nome</label>
            <input id="s-name" name="name" type="text" placeholder="Seu nome completo" required />
          </div>
          <div>
            <label for="s-email">Email</label>
            <input id="s-email" name="email" type="email" placeholder="seu@exemplo.com" required />
          </div>
          <div>
            <label for="s-company">Empresa</label>
            <input id="s-company" name="company" type="text" placeholder="Nome da empresa" required />
          </div>
          <div>
            <label for="s-pass">Senha</label>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input id="s-pass" name="password" type="password" placeholder="Crie uma senha" required />
              <button type="button" class="toggle-pass" data-target="s-pass">Mostrar</button>
            </div>
            <div class="small">Senha mínima: 8 caracteres.</div>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" id="cancel-signup">Cancelar</button>
            <button class="btn primary" type="submit">Criar conta</button>
          </div>
          <div id="signup-msg" class="error" aria-live="polite"></div>
        </form>
      </div>
    </aside>
  </main>

  <script>
    // Tabs
    const btnLogin = document.getElementById('tab-login');
    const btnSignup = document.getElementById('tab-signup');
    const paneLogin = document.getElementById('login');
    const paneSignup = document.getElementById('signup');
    const loginMsg = document.getElementById('login-msg');
    const signupMsg = document.getElementById('signup-msg');
    const currentURL = window.location.href

    function showLogin() {
      btnLogin.classList.add('active');
      btnSignup.classList.remove('active');
      paneLogin.style.display = 'grid';
      paneSignup.style.display = 'none';
      loginMsg.textContent = '';
      signupMsg.textContent = '';
      // Limpa classes de feedback ao trocar de aba
      loginMsg.classList.remove('success');
      loginMsg.classList.add('error');
      signupMsg.classList.remove('success');
      signupMsg.classList.add('error');
    }

    function showSignup() {
      btnSignup.classList.add('active');
      btnLogin.classList.remove('active');
      paneSignup.style.display = 'grid';
      paneLogin.style.display = 'none';
      loginMsg.textContent = '';
      signupMsg.textContent = '';
      // Limpa classes de feedback ao trocar de aba
      loginMsg.classList.remove('success');
      loginMsg.classList.add('error');
      signupMsg.classList.remove('success');
      signupMsg.classList.add('error');
    }

    btnLogin.addEventListener('click', showLogin);
    btnSignup.addEventListener('click', showSignup);

    // Password toggles
    document.querySelectorAll('.toggle-pass').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-target');
        const inp = document.getElementById(id);
        if (!inp) return;
        if (inp.type === 'password') {
          inp.type = 'text';
          btn.textContent = 'Ocultar';
        } else {
          inp.type = 'password';
          btn.textContent = 'Mostrar';
        }
      });
    });
    

    // Handler do Login
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('login').addEventListener('submit', async function (e) {
        e.preventDefault();

        const nome_usuario = document.getElementById('login-name')?.value;
        const senha = document.getElementById('login-pass')?.value;

        if (!nome_usuario || !senha) {
          document.getElementById('login-msg').innerText = 'Preencha todos os campos.';
          return;
        }

        try {
          const response = await fetch(currentURL + '/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nome_usuario, senha })
          });

          const data = await response.json();

          if (data.token) {
            localStorage.setItem('token', data.token);
            alert('Login realizado com sucesso!');
            window.location.href = '/machines';
          } else {
            document.getElementById('login-msg').innerText = data.erro || 'Login falhou.';
          }
        } catch (error) {
          document.getElementById('login-msg').innerText = 'Erro de rede: ' + error.message;
        }
      });
    });

    // Handler do Cadastro
    document.getElementById('signup').addEventListener('submit', async (e) => {
      e.preventDefault();
      signupMsg.textContent = ''; // Limpa mensagens anteriores
      signupMsg.classList.remove('success', 'error'); // Limpa ambas as classes antes de começar

      // Coleta dos dados
      const name = e.target.name.value.trim();
      const email = e.target.email.value.trim();
      const company = e.target.company.value.trim();
      const password = e.target.password.value;

      // Validações básicas (client-side)
      if (name.length < 2) {
        signupMsg.classList.add('error');
        signupMsg.textContent = 'Nome muito curto.';
        return;
      }
      if (!email || !email.includes('@')) {
        signupMsg.classList.add('error');
        signupMsg.textContent = 'Email inválido.';
        return;
      }
      if (password.length < 8) {
        signupMsg.classList.add('error');
        signupMsg.textContent = 'Senha deve ter ao menos 8 caracteres.';
        return;
      }

      // Objeto de dados para o corpo da requisição
      const userData = { name, email, company, password };

      try {
        // Feedback visual de carregamento
        signupMsg.textContent = 'Enviando cadastro...';
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        // Chamada da API POST: '/api/auth/register'
        const response = await fetch(currentURL + '/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(userData)
        });

        // Trata a resposta da API
        if (response.ok) {
          // Sucesso (Status 200-299)
          const result = await response.json();
          // Remove erro e adiciona sucesso
          signupMsg.classList.remove('error');
          signupMsg.classList.add('success');
          signupMsg.textContent = 'Cadastro realizado com sucesso! Você pode fazer login agora.';

          // Redireciona para o login após 3 segundos
          setTimeout(showLogin, 3000);
        } else {
          // Erro (Status 4xx, 5xx)
          const errorData = await response.json();
          // Remove sucesso e adiciona erro
          signupMsg.classList.remove('success');
          signupMsg.classList.add('error');
          signupMsg.textContent = errorData.message || 'Erro ao cadastrar. Verifique os dados.';
        }

      } catch (error) {
        // Erros de rede (não-API)
        signupMsg.classList.remove('success');
        signupMsg.classList.add('error');
        signupMsg.textContent = 'Erro de conexão. Verifique sua rede e tente novamente.';
        console.error('Erro de cadastro:', error);
      } finally {
        // Reabilita o botão
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = false;
      }
    });

    document.getElementById('cancel-signup').addEventListener('click', showLogin);
  </script>
</body>
</html>
